<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251" />
<title>DMDE - Шаблоны редактора дисков</title>
<link rel="stylesheet" href="dmdeman.css" type='text/css' />
<style type="text/css">/*<![CDATA[*/
td,th{vertical-align:top}
/*]]>*/</style>
</head>
<body>
<div id="bklayer">
<div id="wrapper">
<a href="toc.html">Содержание</a> &middot; <a href="howto.html">Работа</a> &middot; <a href="menu.html">Меню</a>
&middot; <a href="menu_viewas.html">Режим</a>
<hr />
<h2>Шаблоны редактора дисков</h2>
<p>
<a href="diskeditor.html">Дисковый редактор</a>,
кроме <a href="menu_viewas.html">встроенных шаблонов</a>, поддерживает
пользовательские шаблоны для просмотра и редактирования различных дисковых структур.
В шаблонах могут использоваться условия, операторы перехода, переменные 
для разбора сложных дисковых структур, таких как записи MFT.</p>

<p>По умолчанию, шаблоны загружаются из файла <span class="tt">template.txt</span>. 
Для использования других файлов можно изменить параметр <span class="tt">editortemplates=</span> 
в <a href="inifile.html">ini-файла</a>,
допуска.тся символы подстановки (например, <span class="tt">editortemplates=template*</span>).
</p>
<p>
В файлах <span class="tt">template.txt</span> и <span class="tt">template.tx_</span> содержатся примеры шаблонов.
</p>

<h3>Структура файла шаблонов</h3>
<p>Каждый шаблон начинается с указания имени в квадратных скобках <span class="tt">[Template Name]</span>,
за которым следуют параметры и команды шаблона (по одной на строку файла).
</p>

<h3>Параметры шаблона</h3>
<p>
<span class="tt">flow:0</span> - отображение по одной записи. <span class="tt">flow:1</span> - отображение записей одна за другой.<br />
<span class="tt">h:Header</span> - отображение постоянного заголовка <span class="tt">Header</span>.
</p>

<h3>Переменные</h3>
<p><span class="tt">$RECSIZE</span> - размер записи шаблона.<br/>
<span class="tt">$OFFSET</span> - относительное смещение, применяемое к <span class="tt">блокам данных</span>.
Если значение <span class="tt">$OFFSET</span> выходит за пределы записи, обработка заканчивается.<br/>
<span class="tt">$1</span> ... <span class="tt">$64</span> - поьзовательские переменные (64-битные целые со знаком).
</p>

<h3>Константы</h3>
<p>Константы указываются в десятичной или шестнадцатеричной (с префиксом <span class="tt">0x</span>) системах.
</p>

<h3>Блоки данных</h3>
<p><b>Блок данных</b> - это, обычно, отдельный байт/слово/двойное слово в указанной позиции,
однако также допустимы диапазоны байтов/бит, обрабатываемых как одно значение.
Блок данных заключается в фигурные скобки <span class="tt">{...}</span>.
</p>
<p>
<span class="tt">{X+Z}</span> определяет диапазон <span class="tt">Z</span> байт, начиная со смещения <span class="tt">X</span>, <br />
<span class="tt">{X:Y+Z}</span> определяет диапазон <span class="tt">Z</span> бит, начиная со смещения <span class="tt">X</span> байт <span class="tt">Y</span> бит,<br />
где <span class="tt">X</span>, <span class="tt">Y</span> и <span class="tt">Z</span> - любые переменные или константы;<br />
несколько диапазонов разделяются запятыми, например, <span class="tt">{0x00+4,$1:$2+4}</span>.
</p>

<h3>Форматы данных</h3>
<p>Формат определяет способ отображения и редактирования блока данных (например, целое число / символ / строка).</p>
<p>Поддерживаются следующие форматы:<br />
<span class="tt">%u</span> - беззнаковое целое (до 32 бит)<br/>
<span class="tt">%D</span> - целое со знаком (32 бита)<br/>
<span class="tt">%I</span> - целое со знаком (64 бита)<br/>
<span class="tt">%X</span> - целое в шестнадцатеричной системе (до 32 бит)<br/>
<span class="tt">%IX</span> - целое в шестнадцатеричной системе (до 64 бит)<br/>
<span class="tt">%c</span> - символ ANSI (8 бит) <br/>
<span class="tt">C</span> - массив символов ANSI <br/>
<span class="tt">U</span> - массив символов Юникода (UTF-16) <br/>
<span class="tt">UNIXDATE</span> - дата в формате Unix (секунды с 1980) <br/>
<span class="tt">FILETIME</span> - дата в формате Windows file time (наносекунды с 1601) <br/>
<span class="tt">F:ABCD..</span> - флаги (где <span class="tt">A</span> отображается, если выставлен бит 0, и <span class="tt">B</span> - если снят, и т.д.)
</p>

<h3>Вывод</h3>
<p>Команда вывода определяет положение на экране и формат блока данных или переменной или выводит текст.</p>
<p>
<span class="tt">{...},x:X,w:W,f:Format</span> выводит блок данных <span class="tt">{...}</span> в колонке <span class="tt">X</span> максимальной ширины <span class="tt">W</span>.
<br />
<span class="tt">x:X,w:W,f:Text</span> выводит <span class="tt">Text</span> в колонке <span class="tt">X</span> максимальной ширины <span class="tt">W</span>.
<br />
<span class="tt">=</span> (знак равенства) означает перевод строки.
</p>

<h3>Условия</h3>
<p>Условия используются следующим образом:<br />
<br />
<span class="tt">IF Condition</span><br />
<span class="tt">&nbsp; ... (команды, которые выполняются, если условие Condition истинно)</span><br />
<span class="tt">ELSE</span><br />
<span class="tt">&nbsp; ... (команды, которые выполняются, если условие Condition ложно)</span><br />
<span class="tt">ENDIF</span><br />
<br />
где <span class="tt">Condition</span> - это сравнение (<span class="tt">==</span>, <span class="tt">&lt;&gt;</span>, <span class="tt">&lt;=</span> и т.д.) 
двух переменных, констант или блоков данных.
</p>

<h3>Метки и переходы</h3>
<p>Строка <span class="tt">LABEL:N</span> определяет метку, 
а команда <span class="tt">GOTO:N</span> - переход на строку <span class="tt">LABEL:N</span>,
где <span class="tt">N</span> - любая константа. Неаккуратное использование оператора перехода <span class="tt">GOTO</span>
может привести к зацикливанию.
</p>

<h3>Оператор присваивания</h3>
<p>Оператор присваивания <span class="tt">:=</span> используется для назначения переменным значений постоянных, 
блоков данных или других переменных, а также результаты их сложения или вычитания, например:
<span class="tt">$1:=$2+{X:Y}</span>, <span class="tt">$OFFSET:=$OFFSET+8</span>.
</p>

<h3>Переключатели</h3>
<p>Переключатели могут использоваться, например, для скрытия/показа некоторых строк 
нажатием клавиши <span class="ii">пробел</span> или кликом мыши. Например, 
команда <span class="tt">$1:=TOGGLE:N,x:X</span> выводит кнопку <span class="tt">[+]</span> (<span class="tt">[-]</span>) в колонке <span class="tt">X</span>, 
где <span class="tt">N</span> - уникальный номер кнопки (допустимы переменные и константы, 
наиболее удобно использовать смещение следующего блока данных);
переменная <span class="tt">$1</span> получает значение <span class="tt">0</span> или <span class="tt">1</span> в зависимости от состояния переключателя.
Только один переключатель может быть в состоянии <span class="tt">1</span>.
</p>

<h3>Дополнительные разделы шаблона</h3>
<p><b>Вычисление размера записи</b> - команды между строками 
<span class="tt">CALCSIZESTART</span> и <span class="tt">CALCSIZEEND</span>.
Используется, если размер записи может быть больше размера сектора и может зависеть от данных.
Значение переменной <span class="tt">$RECSIZE</span> можно изменить только в этом разделе шаблона.
</p>
<p><b>Предварительная обработка данных</b> - команды между строками 
<span class="tt">LOADSTART</span> и <span class="tt">LOADEND</span>.
Используется, например, для обработки USN в записях MFT (восстановление последних двух байт в каждом секторе). 
Блоки данных можно изменять в этом разделе шаблона: 
например, команда <span class="tt">{X+Y}:={Z+Y}</span> копирует <span class="tt">Y</span> байт по смещению <span class="tt">Z</span> 
в позицию по смещению&nbsp;<span class="tt">X</span>.
</p>
<p><b>Постобработка данных</b> - команды между строками 
<span class="tt">FLUSHSTART</span> и <span class="tt">FLUSHEND</span>.
Используется для обратного преобразования перед записью измененных данных на диск 
(также можно изменять блоки данных).
</p>

</div></div>
</body>
</html>